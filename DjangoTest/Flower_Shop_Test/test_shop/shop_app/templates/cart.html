
{% extends "_base.html" %}

{% block title %}Cart{% endblock %}

{% block content %}

   <section class="cart_area " style="background: none">
    <div class="container">
      <div class="cart_inner">
        <div class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th align="center" width="40%">Product</th>
                <th align="center" width="15%">Unit Price</th>

                  <th align="center" width="5%">Inventory</th>
                <th  align="center"width="15%">Quantity</th>
                <th  align="center" width="10%">Sum</th>
                 <th ></th>

                 <th ></th>
                  <th ></th>
                  <th align="center" width="25%">Operation</th>
              </tr>
            </thead>
            <tbody>

    <form action="{% url 'shop_app:addToOrder' %}" method="post">
        {% csrf_token %}
                {% if cart_list %}
                {% for cart_item in cart_list %}

                <tr  class="cart-list" id="one_good">
                <td>
                 <div class="media">
                    <div class="d-flex">
                      <img src="/media/{{cart_item.product.product_image}}" width="180px" alt="" />
                    </div>
                    <div class="media-body" style="margin-left: 10px">
                      <h6>{{cart_item.product.product_name}}</h6>

                    <input class="checkbox" type="checkbox" name="choice" id="choice{{ forloop.counter }}" value="{{ cart_item.cart_id }}">

                  </div>
                </td>


                  <td >
                  <h6 id="price">{{cart_item.product.price}}</h6>
                </td>
                  <td>
                  <h6 align="center"id="inventory">{{cart_item.product.inventory}}</h6>
                </td>
                <td>
                    <div class="col-xl-8 product_count">

          <input class="form-control" id="num" type="number"  min="1" onchange="changeNumber('{{cart_item.cart_id}}',value)" value="{{cart_item.number}}" required>

  </div>

                </td>

                <td>

                <p class="card-text" id="calculated_price" ></p>

                </td>
                  <td>
                  </td>
                  <td>
                   </td>
                    <td>
                   </td>
                  <td>
                   <button  align="center" class="btn btn-sm btn-light border-0" onclick="deleteCart('{{cart_item.cart_id}}', this)">Delete</button>

                </td>

              </tr>
{% endfor %}
    {% else %}

        <p align="center">Sorry... No products in cart.</p>
    {% endif %}

              <tr>
                <td></td>
                <td></td>
                  <td></td>
                   <td>
                       <div class="badge badge-secondary badge-pill" id="total_number"></div>

                </td>
                   <td>
                  <h6 id="total_price">￥0
                 </h6>
                </td>
                  <td></td>

                  <td></td>

                  <td></td>
                  <td></td>
                  <td></td>

              </tr>
    <tr>
        <td></td>
        <td><td>
        <td>
    </td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>

        <td>
      <div class="checkout_btn_inner float-lg-right">
          <button type="submit" class="btn btn-sm btn-primary"  >Checkout</button>


          </div>
        </td>
    </tr>

    </form>
            </tbody>
          </table>



        </div>

        </div>
      </div>

  </section>




<script>
    $(function() {
        // 加载完页面时,计算总计
        calculateItemSum();
        showTotal();
        $('.checkbox').on('click', function () {
        // 选择多选框后,再重新计算
        showTotal();
        });
    });
    // 计算总计函数
    function showTotal() {
        let total = 0;
        let number = 0;
        // 1. 获取所有的被勾选的条目复选框 循环遍历
        $(".checkbox").each(function () {
            let isChecked = $(this).prop("checked");
            // 如果多选框被选中
            if(isChecked === true) {
                // 2. 获取复选框的值，再通过父子关系找到对应元素，获取其文本
                let price = parseFloat($(this).parents("#one_good").find("#price").html()); //得到商品的单价
                console.log("i_price: ",price)
                let num =  parseInt($(this).parents("#one_good").find("#num").val()); //得到商品的数量
                let calculated_price = num * price
                //3. 累加计算
                total += calculated_price;
                number += num;
                // $("#calculated_price").text("￥"+calculated_price.toFixed(2));
            }
        });
    // 4. 把总计显示在总计元素上
    //     console.log("total: ",total)
        $("#total_number").text(number+"  Bouquets");
        $("#total_price").text("￥"+total.toFixed(2));//toFixed(2)函数的作用是把total保留2位
    }


    function setOrder() {
        let total = 0;
        let number = 0;
        // 1. 获取所有的被勾选的条目复选框 循环遍历
        $(".checkbox").each(function () {
            let isChecked = $(this).prop("checked");
            // 如果多选框被选中
            if(isChecked == true) {
                // 2. 获取复选框的值，再通过父子关系找到对应元素，获取其文本
                let price = parseFloat($(this).parents("#one_good").find("#price").html()); //得到商品的单价
                console.log("i_price: ",price)
                let num =  parseInt($(this).parents("#one_good").find("#num").val()); //得到商品的数量
                let calculated_price = num * price
                //3. 累加计算
                total += calculated_price;
                number += 1;
                // $("#calculated_price").text("￥"+calculated_price.toFixed(2));
            }
        });
    // 4. 把总计显示在总计元素上
    //     console.log("total: ",total)
        $("#total_number").text(number+"  Bouquets");
        $("#total_price").text("￥"+total.toFixed(2));//toFixed(2)函数的作用是把total保留2位
    }

















    function calculateItemSum(){

        let each_item = $(".cart-list").each(function (index) {

            let item_price = $(".cart-list #price").eq(index).text();
            // console.log("i_price: ",item_price)
            let num = $(".cart-list #num").eq(index).val();
            // console.log("i_num: ",num)
            let item_sum = item_price * num;
             console.log("i_sum: ",item_sum)
            $(".cart-list #calculated_price").eq(index).text("￥"+item_sum);

        })

    }

function deleteCart(getId, obj) {
    let item = $(obj).parents("#one_good")
    // console.log(item.html())
    // console.log("getId="+getId);
    item.remove()
    $.ajax({
        type : 'post',
        url : '/delete/',
        data:{'getId':getId},
        async : false,
        success : function(data){
            // alert("success delete " + data["getId"]);
        }
    });
}

function changeNumber(getId,value){
    calculateItemSum();
    showTotal();
    $.ajax({
        type : 'post',
        url : '/changenumber/',
        data:{'getId':getId,"changenumber":value},
        async : false,
        success : function(data){
            // alert("success change " + data["getId"]);
        }
    });
}
</script>

{% endblock %}



